================================================================================
          ZNAS 库存管理系统 — BUG 审计报告
          审查日期: 2026-02-10
================================================================================


【致命级 BUG】共 1 个
================================================================================

[BUG-01] PATCH 无法将可空字段清除为 null
--------------------------------------------------------------------------------
文件:     backend/app/routers/items.py  第 167-177 行
描述:     update_item 端点使用 if value is not None 判断用户是否提供了字段。
          但 notes、image_original、image_thumb 在数据库中是 nullable 的。
          None 同时代表"用户没传该字段"和"用户想清空该字段"，逻辑冲突，
          导致用户永远无法通过 API 将已有的备注或图片路径清除为空。
复现:     物料已有图片，发送 PATCH /items/{id}  body {"image_original": null}
          —— 不生效，旧图片路径保留。
影响范围: 所有可空字段的清除操作（notes, image_original, image_thumb）


【严重级 BUG】共 4 个
================================================================================

[BUG-02] API Key 认证中提前 commit 破坏事务完整性
--------------------------------------------------------------------------------
文件:     backend/app/deps.py  第 33-35 行
描述:     _get_user_by_api_key 更新 last_used_at 后直接执行 await session.commit()，
          而此时 endpoint 还没开始执行。后续 endpoint 如果需要 rollback
          （如编码重复触发 IntegrityError），session 的事务边界已经被打乱，
          可能导致数据不一致。
复现:     使用 API Key 调用 POST /items 创建编码重复的物料，
          endpoint 执行 rollback 时事务状态异常。
影响范围: 所有使用 API Key 认证的请求的事务安全性。

[BUG-03] 前端乐观更新与轮询存在竞态条件
--------------------------------------------------------------------------------
文件:     frontend/src/stores/items.js  第 97-166 行
描述:     updateItemOptimistic、stockIn、stockOut 三个方法先通过 findIndex
          获取 index，然后 await HTTP 请求。await 期间 5 秒轮询会调用
          fetchItems() 整体替换 this.items 数组，导致 await 返回后
          index 指向错误的项目或超出数组边界。
复现:     用户编辑一个物料的同时，5 秒轮询触发刷新了列表数据。
          HTTP PATCH 返回后 index 指向了另一个物料，导致错误的物料被覆盖。
影响范围: 所有物料编辑/出入库操作，频率取决于轮询和操作的时间窗口重叠。

[BUG-04] 删除表格(purge)时不清理磁盘图片文件
--------------------------------------------------------------------------------
文件:     backend/app/routers/tables.py  第 133-135 行
描述:     purge_items=true 批量删除物料时使用裸 SQL delete(Item).where(...)，
          完全没有清理关联的 image_original 和 image_thumb 文件。
          与单个删除物料时逐个清理图片的行为不一致。
复现:     删除一个包含 100 个带图片物料的表格（purge_items=true），
          100 张原图和 100 张缩略图永久残留在 /data/images/ 目录。
影响范围: 持续使用会导致磁盘空间泄漏，永远不会被自动清理。

[BUG-05] API Key 明文存储并在列表接口完整返回
--------------------------------------------------------------------------------
文件:     backend/app/routers/integration.py  第 142-153 行
          backend/app/models.py  第 81 行
描述:     API Key 完整原文存储在数据库 api_key 列中（非哈希），
          GET /integration/api-keys 列表接口将完整 Key 返回给前端。
          虽然系统已有 key_hash 列用于哈希查找，但原始 key 也被同时保存。
复现:     任何已认证用户调用 GET /integration/api-keys，
          响应中直接看到所有 API Key 的完整值。
影响范围: 数据库泄露时所有 API Key 明文可见；违反安全最佳实践。


【中等级 BUG】共 5 个
================================================================================

[BUG-06] 更新表格时允许空白名称
--------------------------------------------------------------------------------
文件:     backend/app/routers/tables.py  第 82-83 行
描述:     create_table 在第 43-44 行验证了名称不能为空，
          但 update_table 没有做相同的验证。
          发送 {"name": "   "} 后 strip() 变成空字符串会被写入数据库。
复现:     PATCH /tables/{id}  body {"name": "   "} —— 表格名被设为空字符串。
影响范围: 数据完整性。

[BUG-07] 每次 PATCH 无条件重写 properties 字段
--------------------------------------------------------------------------------
文件:     backend/app/routers/items.py  第 179-187 行
描述:     无论 PATCH 请求是否包含 properties 相关字段，
          代码总是执行 item.properties = working_properties，
          触发 SQLAlchemy 脏检测，导致即使只修改了 name，
          properties 列也被重写，updated_at 也被更新。
复现:     PATCH /items/{id} {"name": "新名称"} —— properties 和
          updated_at 也被无条件更新。
影响范围: 不必要的数据库写入；数据审计 updated_at 不准确。

[BUG-08] PATCH 端点未校验 quantity 非负值
--------------------------------------------------------------------------------
文件:     backend/app/schemas.py  第 56 行
          backend/app/routers/items.py  第 167-177 行
描述:     StockOutRequest 通过 Field(gt=0) 和库存不足检查确保数量合法，
          但 ItemUpdate.quantity 没有 ge=0 约束，也没有在 update_item
          端点中做非负检查。用户可通过 PATCH 直接将库存设为负数，
          完全绕过出库的库存校验逻辑。
复现:     PATCH /items/{id} {"quantity": -100} —— 库存直接变为 -100。
影响范围: 绕过业务规则，破坏库存数据。

[BUG-09] 后端上传接口无文件大小限制（可绕过 nginx）
--------------------------------------------------------------------------------
文件:     backend/app/routers/upload.py  第 34 行
描述:     file_bytes = await file.read() 将整个文件读入内存，无大小限制。
          虽然 nginx 配了 client_max_body_size 30m，但后端 8000 端口
          在 docker-compose.yml 中直接暴露（ports: "8000:8000"），
          可绕过 nginx 直接访问。
复现:     直接向 http://host:8000/upload 发送 2GB 文件，后端 OOM 崩溃。
影响范围: 拒绝服务攻击向量。

[BUG-10] 删除表格 409 冲突时错误信息显示异常
--------------------------------------------------------------------------------
文件:     frontend/src/stores/tables.js  第 62-68 行
          frontend/src/views/SettingsView.vue  第 556 行
描述:     后端返回的 detail 如果是非 TABLE_HAS_ITEMS 的对象类型，
          JavaScript 的 || 运算符会认为对象是 truthy，
          导致 message.error 传入一个对象，页面显示 [object Object]。
复现:     后端返回非预期格式的 409 错误时，前端弹出 [object Object]。
影响范围: 用户体验。


【轻微级 BUG】共 4 个
================================================================================

[BUG-11] create_access_token 当 expires_minutes=0 时使用默认值
--------------------------------------------------------------------------------
文件:     backend/app/core/security.py  第 22 行
描述:     expires_minutes or settings.access_token_expire_minutes 中
          0 被视为 falsy，fallback 到默认值而非生成立即过期的 token。
复现:     调用 create_access_token(subject, expires_minutes=0)
          —— 意外生成长期有效的 token。
影响范围: 当前无调用点传 0，属于潜在风险。

[BUG-12] 扫码入库对新物料发起不必要的额外查询
--------------------------------------------------------------------------------
文件:     frontend/src/views/ListView.vue  第 437-463 行
描述:     扫码入库先调用 findItemInTable() 检查物料是否存在，
          但 POST /stock/in 后端本身已处理"不存在则创建"的逻辑。
          高频扫码场景下浪费一次 HTTP 往返。
复现:     扫描新编码时，实际发送了 2 次请求（1次查询 + 1次入库）。
影响范围: 性能浪费，功能正确。

[BUG-13] JWT 密钥默认值为弱密码
--------------------------------------------------------------------------------
文件:     backend/app/core/config.py  第 13 行
描述:     jwt_secret_key 默认值为 "change_me"，admin_password 默认值为
          "change_me_strong_password"。部署时忘记配置环境变量则
          攻击者可伪造任意用户 token。
复现:     直接 docker compose up 不设置 .env 文件。
影响范围: 部署配置问题。

[BUG-14] ItemDetailView 编辑模式发送冗余 table_id 字段
--------------------------------------------------------------------------------
文件:     frontend/src/views/ItemDetailView.vue  第 188-199, 218 行
描述:     buildPayload() 在编辑模式下构造了包含 table_id 的对象，
          但后端 ItemUpdate schema 没有 table_id 字段，Pydantic 静默忽略。
复现:     编辑物料时请求 body 包含无效的 table_id 字段。
影响范围: 冗余数据传输，不影响功能。


================================================================================
          修复优先级建议
================================================================================

第一优先级（核心功能缺陷）:
  → BUG-01  PATCH 无法清空 nullable 字段
  → BUG-08  quantity 可设负值绕过业务规则
  → BUG-03  前端乐观更新竞态条件

第二优先级（数据安全与完整性）:
  → BUG-02  API Key 认证事务问题
  → BUG-04  删表时图片文件泄漏
  → BUG-05  API Key 明文暴露
  → BUG-06  允许空白表格名

第三优先级（健壮性与体验）:
  → BUG-07  properties 无条件重写
  → BUG-09  上传大小限制绕过
  → BUG-10  错误信息显示异常
  → BUG-11 ~ BUG-14  轻微问题

================================================================================
