# 模块化更新规范（ZNAS）

## 1. 目标

本规范用于指导后续功能以“模块化”方式演进，确保：

- 可独立增减模块，不破坏已有模块。
- 每个模块都具备明确 API 边界。
- 升级、回滚、排错可控。
- NAS 生产环境可平滑更新。

## 2. 模块定义

每个模块必须满足以下最小单元：

- `业务边界`：模块只负责单一业务域（例如：扫码、库存、账号、报表）。
- `数据边界`：模块只依赖已声明的数据模型与外部契约。
- `接口边界`：模块对外暴露 API，不允许通过“读写别的模块内部变量”实现耦合。
- `可观测性`：模块关键动作必须写入日志（含操作者/调用源）。

## 3. 目录约定

推荐按后端/前端双向模块命名：

- 后端：`backend/app/routers/<module>.py`
- 后端服务：`backend/app/services/<module>.py`
- 前端页面：`frontend/src/views/<Module>View.vue`
- 前端状态：`frontend/src/stores/<module>.js`

模块新增必须同步更新：

- `backend/app/routers/integration.py` 的 API 参考。
- README 的功能与部署说明。
- 本规范中的“模块清单”。

## 4. API 设计硬规则

每个模块都必须提供（按需裁剪）：

- `查询`：至少一个 list/detail 查询接口。
- `写入`：create/update/delete 或等价操作接口。
- `鉴权`：必须接入统一鉴权（JWT 或 API Key）。
- `错误码`：返回可读 detail，不允许无语义 500。
- `审计日志`：写操作必须记录 action、target、summary、auth_source。

接口设计建议：

- 路径命名使用复数资源名，例如 `/items`、`/tables`。
- 变更操作优先 `PATCH`（部分更新）和 `POST`（业务动作）。
- 高风险操作（回滚/批量删除）要求二次确认参数。

## 5. 数据变更规范

新增或修改表结构时必须遵循：

- `向后兼容优先`：先加字段再迁移，不先删字段。
- `可回滚`：迁移脚本需允许旧版本读取关键数据。
- `默认值明确`：避免 NULL 语义不清导致线上报错。

执行顺序：

1. 先写迁移逻辑（`migration.py`）。
2. 再改业务代码。
3. 最后在 UI 暴露新能力。

## 6. 版本与发布规范

采用语义版本：

- `MAJOR`：不兼容变更。
- `MINOR`：向后兼容功能新增。
- `PATCH`：缺陷修复。

发布要求：

- 必须打 tag，例如 `v1.2.0`。
- 更新说明必须包含：变更点、影响范围、回滚方式。
- 镜像版本与代码 tag 对齐（`APP_VERSION`）。

## 7. 更新流程（生产）

1. 发布前检查

- 所有写操作路径具备日志。
- 健康检查通过。
- 升级脚本、回滚脚本可执行。

2. 执行更新

- Web：系统运维 -> 检查更新 -> 一键更新。
- 或脚本：`bash scripts/nas_update.sh`。

3. 回归验证

- 登录、列表、入库/出库、上传、扫码、设置、日志。

4. 异常回滚

- Web：系统运维 -> 精确回滚到 tag/commit。
- 或脚本：`bash scripts/nas_rollback.sh <tag-or-commit>`。

## 8. 模块准入清单（合并前必须满足）

- 是否定义了清晰的模块边界。
- 是否提供了完整 API 与鉴权。
- 是否补齐操作日志。
- 是否考虑了升级与回滚。
- 是否更新 README 与 API 参考。
- 是否通过本地构建与健康检查。

## 9. 禁止事项

- 禁止跨模块直接访问内部状态。
- 禁止把敏感校验只放在前端。
- 禁止无版本说明直接发布到生产。
- 禁止跳过日志记录上线高风险功能。

## 10. 建议的后续增强

- 为关键模块增加契约测试（API schema 测试）。
- 为回滚与更新增加执行状态页（进度、耗时、失败点）。
- 引入变更单模板，固化发布审核流程。
